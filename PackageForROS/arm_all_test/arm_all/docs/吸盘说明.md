# ROS/Gazebo 吸盘插件使用说明（arm_all 包）

本说明基于 `urdf/gazebo/arm_all.xacro` 中的吸盘实现，介绍其用途、依赖、话题接口、如何启用与测试、常见问题与调参建议，便于在 Gazebo 中稳定实现“真空吸附-释放”的效果。

---

## 插件概述

- 插件名称：`gazebo_ros_vacuum_gripper`
- 动态库：`libgazebo_ros_vacuum_gripper.so`
- 作用：
  - 向 Gazebo 中的某个链接（吸盘）附着/分离其它接触中的物体，实现“真空吸附”效果；
  - 通过 ROS 话题接收布尔消息控制吸附开关。
- 集成位置：`arm_all.xacro` 使用 Xacro 宏 `add_suction_cup` 在机械臂末端 `link4` 上实例化 9 个吸盘（1 个中心 + 8 个环绕）。

> 说明：不同来源的 `gazebo_ros_vacuum_gripper` 插件实现略有差异，`arm_all.xacro` 同时提供 `bodyName/linkName/link_name` 与 `topicName/topic_name` 以增强兼容性。

---

## 运行依赖

- ROS + Gazebo（Gazebo Classic）与 `gazebo_ros` 集成环境；
- 提供 `libgazebo_ros_vacuum_gripper.so` 的插件包（请确保系统中存在该库，Gazebo 启动时若找不到会在终端报错）。

检查方式（启动 Gazebo 后若报错，重点检查以下内容）：
- 插件库路径是否可被 Gazebo 找到（Gazebo 插件搜索路径）；
- 插件所在 ROS 包是否已安装/编译；
- ROS 环境是否已 `source devel/setup.bash`。

---

## 在模型中如何启用（arm_all.xacro 摘要）

### 1) Xacro 顶层参数

- `vacuum_prefix`（默认：`/arm`）：作为吸盘插件的命名空间前缀，用于区分多个机械臂或多套吸盘。

### 2) 吸盘宏 `add_suction_cup`

- 用途：一次性创建一个吸盘的 `link`、连接 `joint`、插件配置、碰撞/接触参数等；
- 关键参数（带默认值）：
  - `suffix`: 名称后缀（例如 `_1`、`_2`），用于区分同组中的多个吸盘；
  - `parent`: 吸盘父链接（默认 `link4`）；
  - `x y z / roll pitch yaw`: 相对父链接的位姿（默认 `x=-0.133, y=0, z=0, pitch=1.5708` 等）；
  - `ns`: 插件命名空间（默认 `${vacuum_prefix}/vacuum_gripper`）；
  - `topic`: 吸附控制话题的基础名（默认 `grasping`）；
  - `radius/length/mass`: 吸盘几何与质量；
  - 接触与数值稳定相关：`mu`（摩擦）、`kp/kd`（接触刚度/阻尼）、`maxForce`、`maxDistance/minDistance`、`contact*` 等。

该宏会创建：
- `link`：`vacuum_gripper{suffix}`（视觉/碰撞为短圆柱，原点位于圆柱端面，便于将端面贴合物体表面）；
- `joint`：`gripper_joint{suffix}`（极小转动范围替代固定关节，避免 URDF→SDF 固定关节合并导致子链接丢失）；
- Gazebo 插件块：为该吸盘链接加载 `gazebo_ros_vacuum_gripper` 并配置命名空间与话题名；
- Gazebo 接触/物理参数：针对吸盘链接提升接触稳定性和摩擦系数。

### 3) 9 个吸盘的布局

- 统一基准位姿：
  - `cup_base_x=-0.133, cup_base_y=0, cup_base_z=0.00`
- 实例：
  - 中心：`suffix=""`；
  - 环绕 8 个：`_1 .. _8`，在 `y/z` 平面以约 `0.03m` 半径分布；
- 所有吸盘的父链接均为 `link4`，可整体作为末端执行器使用。

### 4) transmissions（用于 joint_state 发布）

- 为 `gripper_joint{suffix}` 添加 `transmission_interface/SimpleTransmission`（Effort 接口），使 `joint_state_controller` 能发布它们；
- 吸盘关节本身不需要执行控制（基本等效固定，仅为避免关节合并）。

---

## 话题接口（控制吸附/释放）

插件通过 `std_msgs/Bool` 消息控制：
- `data=true` 吸附（Attach）
- `data=false` 释放（Detach）

话题完整名由两部分组成：
- 插件命名空间：`ns + suffix`（当 `suffix` 为空时，不追加后缀）；
- 话题名：`topic + suffix`（同上规则）。

因此，若使用默认 `vacuum_prefix=/arm` 与 `topic=grasping`：
- 中心吸盘：
  - 命名空间：`/arm/vacuum_gripper`
  - 话题：`/arm/vacuum_gripper/grasping`
- 第一个环绕吸盘（`suffix=_1`）：
  - 命名空间：`/arm/vacuum_gripper_1`
  - 话题：`/arm/vacuum_gripper_1/grasping_1`
- 以此类推，直到 `_8`。

> 注：话题名在 URDF 中未以 `/` 开头，因此按 ROS 解析规则会相对于插件命名空间解析为以上全名。

---

## 启动与测试步骤

1) 编译工作区（若未编译或有改动）：

```bash
catkin_make --directory /home/zy/simulation -DCMAKE_BUILD_TYPE=RelWithDebInfo
source /home/zy/simulation/devel/setup.bash
```

2) 启动仿真（仓库已提供示例启动）：

```bash
roslaunch arm_all rviz_gazebo.launch
```

3) 在 Gazebo 中将吸盘端面轻触目标物体表面；

4) 通过话题切换吸附状态（示例：中心吸盘）：

- 吸附：

```bash
rostopic pub -1 /arm/vacuum_gripper/grasping std_msgs/Bool "data: true"
```

- 释放：

```bash
rostopic pub -1 /arm/vacuum_gripper/grasping std_msgs/Bool "data: false"
```

5) 其它环绕吸盘的示例（如 `_1`）：

```bash
rostopic pub -1 /arm/vacuum_gripper_1/grasping_1 std_msgs/Bool "data: true"
```

> 如需一次性控制多枚吸盘，可在上层封装一个节点/脚本，向多个话题发布一致的状态。

---

## 可调参数与建议

以下参数在 `add_suction_cup` 宏中可按需调整：

- 物理/接触：
  - `mu`：摩擦系数（默认 15）；
  - `kp/kd`：接触刚度/阻尼（默认 `kp=12000.0, kd=200.0`）；
  - `contactMaxCorrectingVel`：接触修正最大速度（默认 0.01，降低可提升稳定性）；
  - `contactSurfaceLayer`：表面层厚度（默认 0.008，加厚可缓解抖动）；
  - `minDepth`：最小接触深度（默认 0.001）。
- 吸附能力：
  - `maxForce`：最大吸附力（默认 `0.001`，数值过小会导致轻碰即脱落，可在不破坏数值稳定的前提下适当增大）；
  - `maxDistance/minDistance`：吸附保持/触发的距离阈值（单位米）。
- 几何与质量：
  - `radius/length/mass`：吸盘大小与质量，影响受力与碰撞。
- 位姿与命名：
  - `x y z / rpy`：相对 `parent` 的安装位姿；
  - `suffix` 与 `ns/topic`：命名空间与话题名。

调参建议：
- 若“吸住后抖动/穿透”：先降低 `contactMaxCorrectingVel`，适度增大 `contactSurfaceLayer` 与 `kd`；
- 若“难以吸住/容易掉落”：适度增大 `maxForce`，同时检查目标物体碰撞体是否足够“厚实”且包含惯性；
- 若“吸盘在 URDF→SDF 后消失”：保持使用很小范围的关节替代固定关节（本模型已处理）。

---

## 常见问题排查（FAQ）

1) Gazebo 报错“无法加载插件/找不到库”
   - 确认系统存在 `libgazebo_ros_vacuum_gripper.so`；
   - 检查 Gazebo 插件搜索路径与 ROS 包；
   - 重新 `source devel/setup.bash`；必要时查找插件提供包是否已安装。

2) 发布 `std_msgs/Bool` 后无反应
   - 确认发布到正确的话题全名（含命名空间与后缀）；
   - 终端查看 `rosnode list` 与 `rostopic list`，确认插件节点与话题是否存在；
   - 目标物体需具有碰撞体与惯性，且与吸盘端面接触；
   - 如果模型复杂，尝试先只启用“中心吸盘”验证流程。

3) 吸住后轻微抖动或缓慢滑脱
   - 增大 `mu`、`kp/kd`，减小 `contactMaxCorrectingVel`，加厚 `contactSurfaceLayer`；
   - 适度增大 `maxForce`；
   - 确认仿真步长、实时因子稳定（过大步长可能放大数值误差）。

4) 吸盘姿态怪异或吸附方向不对
   - 检查 `roll/pitch/yaw`（默认 `pitch=1.5708` 表示吸盘轴向对准世界 `y`→`z` 的变换）；
   - 确保安装到正确父链接 `parent`，并校准 `x y z` 位移。

---

## 扩展用法

- 自定义布局：
  - 更改 `cup_base_*` 或逐个 `add_suction_cup` 实例的位姿参数；
  - 添加/删除吸盘：复制/删除 `xacro:add_suction_cup` 调用，并为新实例添加唯一 `suffix`。
- 命名空间调整：
  - 通过 Launch 传参覆盖 `vacuum_prefix`，以实现多机械臂/多工具分组管理；
- 与控制器集成：
  - 已为 `gripper_joint{suffix}` 注入 `transmission`，确保 `joint_state_controller` 能发布它们；
  - 吸盘开关由插件自身订阅话题，不需要额外的 `ros_control` 控制器。

---

## 快速参考（话题一览）

默认 `vacuum_prefix=/arm`：
- 中心：`/arm/vacuum_gripper/grasping`
- `_1`：`/arm/vacuum_gripper_1/grasping_1`
- `_2`：`/arm/vacuum_gripper_2/grasping_2`
- `_3`：`/arm/vacuum_gripper_3/grasping_3`
- `_4`：`/arm/vacuum_gripper_4/grasping_4`
- `_5`：`/arm/vacuum_gripper_5/grasping_5`
- `_6`：`/arm/vacuum_gripper_6/grasping_6`
- `_7`：`/arm/vacuum_gripper_7/grasping_7`
- `_8`：`/arm/vacuum_gripper_8/grasping_8`

---

## 版本与兼容性

- 本说明以 `src/arm_all/urdf/gazebo/arm_all.xacro` 为准；
- 如需迁移至其他模型或 Gazebo 版本，重点核对：
  - 插件库名与可用性；
  - URDF→SDF 转换对固定关节的处理（已通过微小转动关节规避）；
  - 话题命名与命名空间解析行为是否一致。

---

如需进一步封装统一控制节点、自动选择最近的吸盘进行吸附等高级功能，可在此文档基础上扩展实现。